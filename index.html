<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Axion Interface - Quantum Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

        :root {
            --primary-color: #00ffcc;
            --secondary-color: #38bdf8;
            --alert-color: #ff4444;
            --bg-dark: #0a101b;
            --bg-medium: #111a28;
            --panel-bg: rgba(10, 16, 27, 0.7);
            --border-color: rgba(0, 255, 204, 0.3);
            --log-scrollbar-thumb: #00ffccaa;
            --log-scrollbar-track: #1a202c;
            --focus-outline: 2px solid var(--primary-color);
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background: radial-gradient(circle at 50% 50%, var(--bg-medium), var(--bg-dark));
            color: #e0f7fa;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        .dashboard-container {
            border: 2px solid var(--border-color);
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
            backdrop-filter: blur(5px);
            background-color: var(--panel-bg);
            transition: all 0.3s ease-in-out;
        }

        .glow-text {
            text-shadow: 0 0 8px var(--primary-color), 0 0 15px rgba(0, 255, 204, 0.4);
            transition: text-shadow 0.3s ease-in-out;
        }

        .gauge-ring {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .log-container {
            font-family: 'Roboto Mono', monospace;
            scrollbar-width: thin;
            scrollbar-color: var(--log-scrollbar-thumb) var(--log-scrollbar-track);
        }

        .log-container::-webkit-scrollbar {
            width: 6px;
        }

        .log-container::-webkit-scrollbar-track {
            background: var(--log-scrollbar-track);
        }

        .log-container::-webkit-scrollbar-thumb {
            background: var(--log-scrollbar-thumb);
            border-radius: 3px;
        }

        .listening {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            box-shadow: 0 0 10px var(--primary-color);
        }

        input:focus, button:focus {
            outline: none;
            box-shadow: 0 0 12px var(--primary-color), inset 0 0 8px var(--primary-color);
            transform: translateY(-2px);
        }

        .quick-command-btn {
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, transform 0.1s ease-in-out;
            border: 1px solid transparent;
            box-shadow: inset 0 0 5px rgba(0, 255, 204, 0.1);
        }

        .quick-command-btn:hover,
        .quick-command-btn:focus {
            background-color: #06b6d4;
            border-color: #00ffcc;
            box-shadow: 0 0 10px var(--primary-color), inset 0 0 8px var(--primary-color);
            transform: scale(1.02);
        }

        .quick-command-btn.emergency {
            background-color: #b91c1c;
            color: white;
            box-shadow: inset 0 0 5px rgba(255, 68, 68, 0.2);
        }

        .quick-command-btn.emergency:hover,
        .quick-command-btn.emergency:focus {
            background-color: #dc2626;
            border-color: #ff4444;
            box-shadow: 0 0 10px var(--alert-color), inset 0 0 8px var(--alert-color);
            transform: scale(1.02);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: background-color 0.5s ease;
            animation: pulse-status 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .status-indicator.optimal {
            background-color: #00ffcc;
            box-shadow: 0 0 8px #00ffcc;
        }
        .status-indicator.warning {
            background-color: #ffcc00;
            box-shadow: 0 0 8px #ffcc00;
        }
        .status-indicator.critical {
            background-color: #ff4444;
            box-shadow: 0 0 8px #ff4444;
        }

        @keyframes pulse-status {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6 bg-gray-900">
    <main class="w-full max-w-6xl dashboard-container rounded-3xl p-8 space-y-8" role="main" aria-label="Axion Quantum Core Interface">
        <header class="flex flex-col sm:flex-row justify-between items-center border-b pb-4 border-gray-700" role="banner">
            <h1 class="text-4xl font-bold glow-text text-cyan-400 mb-4 sm:mb-0" aria-label="Axion Quantum Core Title">AXION QUANTUM CORE</h1>
            <div class="text-right flex items-center space-x-2" aria-live="polite" aria-atomic="true">
                <div id="systemHealth" class="status-indicator optimal"></div>
                <div>
                    <p class="text-sm text-gray-400">Operational Mode</p>
                    <p id="currentMode" class="text-2xl text-white font-bold" aria-live="polite" aria-atomic="true">TOWER</p>
                </div>
            </div>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-4 gap-6" aria-label="System Metrics and Status">
            <article class="flex flex-col items-center justify-center p-4 rounded-lg border border-gray-700/50 bg-gray-800/40 col-span-1 md:col-span-2" aria-label="Core Metrics">
                <h2 class="text-2xl font-semibold mb-4 text-white">Quantum Core Metrics</h2>
                <div class="flex space-x-8 mb-4">
                    <div class="flex flex-col items-center" role="group" aria-label="Energy output">
                        <div class="relative w-28 h-28">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle class="text-gray-700 stroke-current" stroke-width="6" cx="50" cy="50" r="45" fill="transparent"></circle>
                                <circle class="text-cyan-400 stroke-current gauge-ring" stroke-width="8" cx="50" cy="50" r="45" fill="transparent" id="energyGaugeSVG"></circle>
                            </svg>
                            <span id="energyOutput" class="absolute inset-0 flex items-center justify-center text-xl font-bold text-green-400">93%</span>
                        </div>
                        <span class="mt-2 text-sm text-gray-400">ENERGY</span>
                    </div>
                    <div class="flex flex-col items-center" role="group" aria-label="Reactor output">
                        <div class="relative w-28 h-28">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle class="text-gray-700 stroke-current" stroke-width="6" cx="50" cy="50" r="45" fill="transparent"></circle>
                                <circle class="text-blue-400 stroke-current gauge-ring" stroke-width="8" cx="50" cy="50" r="45" fill="transparent" id="reactorGaugeSVG"></circle>
                            </svg>
                            <span id="reactorOutput" class="absolute inset-0 flex items-center justify-center text-xl font-bold text-blue-400">97%</span>
                        </div>
                        <span class="mt-2 text-sm text-gray-400">REACTOR</span>
                    </div>
                </div>
                <div class="flex flex-col items-center" role="group" aria-label="Suit integrity">
                    <div class="relative w-28 h-28">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="text-gray-700 stroke-current" stroke-width="6" cx="50" cy="50" r="45" fill="transparent"></circle>
                            <circle class="text-purple-400 stroke-current gauge-ring" stroke-width="8" cx="50" cy="50" r="45" fill="transparent" id="integrityGaugeSVG"></circle>
                        </svg>
                        <span id="integrityOutput" class="absolute inset-0 flex items-center justify-center text-xl font-bold text-purple-400">100%</span>
                    </div>
                    <p class="mt-2 text-sm text-gray-400">SUIT INTEGRITY</p>
                </div>
            </article>

            <section class="md:col-span-2 p-4 rounded-lg border border-gray-700/50 bg-gray-800/40" aria-label="System Subsystems Status">
                <h2 class="text-xl font-semibold mb-2 text-white">Subsystem Status</h2>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-gray-400">Photonic Emitters:</p>
                        <p id="lightsStatus" class="text-green-400 font-bold" aria-live="polite" aria-atomic="true">100%</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Ventilation:</p>
                        <p id="fanStatus" class="text-yellow-400 font-bold" aria-live="polite" aria-atomic="true">Off</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Primary Airlock:</p>
                        <p id="doorStatus" class="text-red-400 font-bold" aria-live="polite" aria-atomic="true">Sealed</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Energy Shielding:</p>
                        <p id="defenseStatus" class="text-gray-300 font-bold" aria-live="polite" aria-atomic="true">Offline</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Maneuvering Thrusters:</p>
                        <p id="boostersStatus" class="text-gray-300 font-bold" aria-live="polite" aria-atomic="true">Offline</p>
                    </div>
                    <div>
                        <p class="text-gray-400">AI Core State:</p>
                        <p id="aiStatus" class="text-cyan-400 font-bold" aria-live="polite" aria-atomic="true">Nominal</p>
                    </div>
                </div>
                <p id="systemStatus" class="mt-4 text-gray-500 italic text-sm" aria-live="polite" aria-atomic="true">
                    Tower mode active. Quantum entanglement stable.
                </p>
            </section>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-2 gap-6" aria-label="Command Console">
            <section class="p-4 rounded-lg border border-gray-700/50 bg-gray-800/40" aria-label="Quantum Protocols">
                <h2 class="text-xl font-semibold mb-3 text-white">Quantum Protocols</h2>
                <div class="grid grid-cols-2 gap-3">
                    <button type="button" data-command="toggle lights" class="quick-command-btn p-3 bg-gray-700 rounded-lg" aria-label="Toggle photonic emitters" title="Toggle the photonic emitters">EMITTERS ON/OFF</button>
                    <button type="button" data-command="scan area" class="quick-command-btn p-3 bg-gray-700 rounded-lg" aria-label="Initiate perimeter scan" title="Initiate a perimeter scan">PERIMETER SCAN</button>
                    <button type="button" data-command="system status" class="quick-command-btn p-3 bg-gray-700 rounded-lg" aria-label="Run full system diagnostic" title="Run a full system diagnostic">DIAGNOSTICS</button>
                    <button type="button" data-command="toggle fan" class="quick-command-btn p-3 bg-gray-700 rounded-lg" aria-label="Toggle ventilation" title="Toggle ventilation">VENTILATION</button>
                    <button type="button" data-command="toggle defenses" class="quick-command-btn p-3 bg-gray-700 rounded-lg" aria-label="Toggle energy shielding" title="Toggle energy shielding">SHIELDING</button>
                    <button type="button" data-command="toggle boosters" class="quick-command-btn p-3 bg-gray-700 rounded-lg" aria-label="Toggle maneuvering thrusters" title="Toggle maneuvering thrusters">THRUSTERS</button>
                    <button type="button" data-command="toggle mode" class="quick-command-btn p-3 bg-gray-700 rounded-lg" aria-label="Toggle operational mode" title="Switch between operational modes">TOGGLE MODE</button>
                    <button type="button" data-command="toggle door" class="quick-command-btn p-3 bg-gray-700 rounded-lg" aria-label="Toggle primary airlock" title="Open or seal the airlock">AIRLOCK</button>
                    <button type="button" data-command="ping" class="quick-command-btn p-3 bg-gray-700 rounded-lg" aria-label="Send a quantum ping" title="Send a diagnostic ping">QUANTUM PING</button>
                    <button type="button" data-command="system reboot" class="quick-command-btn p-3 bg-gray-700 rounded-lg" aria-label="Initiate system reboot" title="Initiate a full system reboot">REBOOT CORE</button>
                    <button type="button" data-command="emergency shutdown" class="quick-command-btn emergency p-3 rounded-lg" aria-label="Initiate emergency shutdown" title="Initiate an immediate and total system shutdown">EMERGENCY SHUTDOWN</button>
                </div>
            </section>

            <section class="p-4 rounded-lg border border-gray-700/50 bg-gray-800/40 flex flex-col" aria-label="Command Console">
                <h2 class="text-xl font-semibold mb-3 text-white">Console Log</h2>
                <div id="logContainer" class="log-container flex-grow h-64 overflow-y-auto space-y-3 text-sm" role="log" aria-live="polite" aria-atomic="false" tabindex="0">
                    <div class="text-gray-300">
                        <span class="text-cyan-400">AXION OS:</span> Boot sequence complete. All systems nominal.
                    </div>
                </div>

                <div class="mt-4 flex space-x-3">
                    <button type="button" id="clearLogBtn" class="px-5 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg" title="Clear the console log">PURGE LOG</button>
                </div>

                <form id="commandForm" class="mt-4 flex space-x-3" role="search" aria-label="Command input form">
                    <input
                        type="text"
                        id="commandInput"
                        placeholder="EXECUTE PROTOCOL..."
                        class="flex-1 bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600"
                        autocomplete="off"
                        spellcheck="false"
                        aria-label="Command input"
                    />
                    <button type="button" id="voiceBtn" class="px-3 py-2 bg-gray-700 rounded-lg" aria-pressed="false" aria-label="Toggle voice command" title="Toggle voice command">
                        <span id="voiceBtnIcon">🎤</span>
                    </button>
                    <button type="submit" class="px-5 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg" aria-label="Send command">RUN</button>
                </form>
            </section>
        </section>
    </main>
    <script>
        class QuantumDashboard {
            constructor() {
                this.dom = {
                    logContainer: document.getElementById('logContainer'),
                    commandForm: document.getElementById('commandForm'),
                    commandInput: document.getElementById('commandInput'),
                    currentMode: document.getElementById('currentMode'),
                    systemStatus: document.getElementById('systemStatus'),
                    lightsStatus: document.getElementById('lightsStatus'),
                    fanStatus: document.getElementById('fanStatus'),
                    doorStatus: document.getElementById('doorStatus'),
                    defenseStatus: document.getElementById('defenseStatus'),
                    boostersStatus: document.getElementById('boostersStatus'),
                    aiStatus: document.getElementById('aiStatus'),
                    energyOutput: document.getElementById('energyOutput'),
                    reactorOutput: document.getElementById('reactorOutput'),
                    integrityOutput: document.getElementById('integrityOutput'),
                    energyGaugeSVG: document.getElementById('energyGaugeSVG'),
                    reactorGaugeSVG: document.getElementById('reactorGaugeSVG'),
                    integrityGaugeSVG: document.getElementById('integrityGaugeSVG'),
                    voiceBtn: document.getElementById("voiceBtn"),
                    voiceBtnIcon: document.getElementById("voiceBtnIcon"),
                    quickCommandButtons: document.querySelectorAll('.quick-command-btn'),
                    systemHealthIndicator: document.getElementById('systemHealth'),
                    clearLogBtn: document.getElementById('clearLogBtn')
                };

                this.state = {
                    mode: "TOWER",
                    lights: 100,
                    ventilation: 0,
                    airlock: "Sealed",
                    shielding: "Offline",
                    thrusters: "Offline",
                    energyOutput: 93,
                    reactorOutput: 97,
                    suitIntegrity: 100,
                    health: 'optimal',
                    aiStatus: 'Nominal',
                    awaitingConfirmation: null,
                    isBusy: false,
                    abortTimeout: null, // New state variable to hold the timeout ID
                };
                
                this.speechRecognition = null;
                this.isListening = false;
                this.recognitionSupported = 'SpeechRecognition' in window || 'webkitSpeechRecognition' in window;

                this.commands = new Map([
                    ['toggle lights', { handler: () => this.toggleSubsystem('lights', 'Photonic Emitters') }],
                    ['scan area', { handler: () => this.runAsyncCommand("PERIMETER SCAN initiated...", "PERIMETER SCAN complete. No threats detected.", "PERIMETER SCAN aborted.", 2500) }],
                    ['system status', { handler: () => this.runAsyncCommand('Executing core diagnostics...', 'Diagnostics complete. All systems confirmed.', 'Diagnostics aborted.', 1500, () => this.runDiagnostics()) }],
                    ['toggle fan', { handler: () => this.toggleSubsystem('ventilation', 'Ventilation') }],
                    ['toggle defenses', { handler: () => this.toggleSubsystem('shielding', 'Energy Shielding') }],
                    ['toggle boosters', { handler: () => this.toggleSubsystem('thrusters', 'Maneuvering Thrusters') }],
                    ['toggle mode', { handler: () => this.toggleMode() }],
                    ['toggle door', { handler: () => this.toggleAirlock() }],
                    ['ping', { handler: () => this.runAsyncCommand('Sending quantum core ping...', 'Quantum core ping received. Latency: <1ms.', 'Ping aborted.', 500) }],
                    ['system reboot', { handler: () => this.runAsyncCommand('Initiating core reboot sequence...', 'System reboot complete. Quantum state restored.', 'Reboot aborted.', 1500, () => this.rebootSystem()) }],
                    ['emergency shutdown', { handler: () => this.requestConfirmation('emergency shutdown') }],
                    ['confirm shutdown', { handler: () => this.executeConfirmedShutdown() }],
                    ['set lights', { handler: (args) => this.setNumericValue('lights', args[1], 0, 100, 'Photonic Emitters') }],
                    ['set ventilation', { handler: (args) => this.setNumericValue('ventilation', args[1], 0, 5, 'Ventilation') }],
                    ['set thrusters', { handler: (args) => this.setNumericValue('thrusters', args[1], 0, 100, 'Maneuvering Thrusters') }],
                    ['set airlock', { handler: (args) => this.setAirlockState(args[1]) }],
                    ['abort protocol', { handler: () => this.abortProtocol() }], // New command to stop a pending operation
                ]);
                
                this.init();
            }

            init() {
                this.dom.commandForm.addEventListener('submit', (e) => this.handleCommandInput(e));
                this.dom.quickCommandButtons.forEach(button => {
                    button.addEventListener('click', () => this.executeCommand(button.dataset.command));
                });
                this.dom.clearLogBtn.addEventListener('click', () => this.clearLog());
                if (this.recognitionSupported) {
                    this.dom.voiceBtn.addEventListener('click', () => this.toggleVoiceCommand());
                    this.initSpeechRecognition();
                } else {
                    this.dom.voiceBtn.style.display = 'none';
                    this.addToLog('Voice command interface offline.', true);
                }
                this.updateDisplay();
            }
            
            updateDisplay() {
                this.dom.currentMode.textContent = this.state.mode;
                this.dom.lightsStatus.textContent = this.state.lights > 0 ? `${this.state.lights}%` : 'Offline';
                this.dom.fanStatus.textContent = this.state.ventilation > 0 ? `Speed ${this.state.ventilation}` : 'Offline';
                this.dom.doorStatus.textContent = this.state.airlock;
                this.dom.defenseStatus.textContent = this.state.shielding;
                this.dom.boostersStatus.textContent = this.state.thrusters;
                this.dom.aiStatus.textContent = this.state.aiStatus;
                this.dom.energyOutput.textContent = `${this.state.energyOutput}%`;
                this.dom.reactorOutput.textContent = `${this.state.reactorOutput}%`;
                this.dom.integrityOutput.textContent = `${this.state.suitIntegrity}%`;
                this.updateGauges();
                this.updateHealthIndicator();
                this.updateSystemStatusMessage();
            }

            updateGauges() {
                this.setGaugeValue(this.dom.energyGaugeSVG, this.state.energyOutput);
                this.setGaugeValue(this.dom.reactorGaugeSVG, this.state.reactorOutput);
                this.setGaugeValue(this.dom.integrityGaugeSVG, this.state.suitIntegrity);
            }

            setGaugeValue(gaugeElement, value) {
                const circumference = 2 * Math.PI * 45;
                const offset = circumference - (value / 100) * circumference;
                gaugeElement.style.strokeDashoffset = offset;
            }

            updateHealthIndicator() {
                let health = 'optimal';
                if (this.state.energyOutput < 30 || this.state.reactorOutput < 30 || this.state.suitIntegrity < 30) {
                    health = 'critical';
                } else if (this.state.energyOutput < 60 || this.state.reactorOutput < 60 || this.state.suitIntegrity < 60) {
                    health = 'warning';
                }
                this.dom.systemHealthIndicator.className = `status-indicator ${health}`;
            }

            updateSystemStatusMessage() {
                const messages = {
                    'TOWER': 'Tower mode active. Quantum entanglement stable.',
                    'ARMOR': 'Armor mode engaged. Biometric lock active.',
                    'CRITICAL': 'WARNING: Critical system failure. Initiate reboot or shutdown protocol.',
                    'REBOOT': 'Initiating core reboot sequence. Stand by.',
                };
                let message = messages[this.state.mode] || messages.TOWER;
                if (this.state.health === 'critical') {
                    message = messages.CRITICAL;
                }
                this.dom.systemStatus.textContent = message;
            }
            
            addToLog(message, isError = false) {
                const logEntry = document.createElement('div');
                logEntry.classList.add('fade-in');
                const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
                let logMessage = `<span class="text-gray-500">[${timestamp}] | </span><span class="${isError ? 'text-red-400' : 'text-cyan-400'}">AXION:</span> ${message}`;
                logEntry.innerHTML = logMessage;
                this.dom.logContainer.appendChild(logEntry);
                this.dom.logContainer.scrollTop = this.dom.logContainer.scrollHeight;
                return logEntry; // Return the created element for later updates
            }

            updateLogEntry(logEntry, message, isError = false) {
                const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
                let logMessage = `<span class="text-gray-500">[${timestamp}] | </span><span class="${isError ? 'text-red-400' : 'text-cyan-400'}">AXION:</span> ${message}`;
                logEntry.innerHTML = logMessage;
                logEntry.classList.add('fade-in');
                this.dom.logContainer.scrollTop = this.dom.logContainer.scrollHeight;
            }

            clearLog() {
                this.dom.logContainer.innerHTML = '';
                this.addToLog('Console log purged.', false);
            }

            handleCommandInput(event) {
                event.preventDefault();
                const command = this.dom.commandInput.value.trim().toLowerCase();
                if (command) {
                    this.executeCommand(command);
                    this.dom.commandInput.value = '';
                }
            }
            
            async executeCommand(input) {
                const trimmedInput = input.trim().toLowerCase();

                if (trimmedInput === 'confirm shutdown' && this.state.awaitingConfirmation === 'emergency shutdown') {
                    this.addToLog(`> ${trimmedInput}`, false);
                    this.executeConfirmedShutdown();
                    return; 
                }

                if (this.state.isBusy && trimmedInput !== 'abort protocol') {
                    this.addToLog('System busy. Please wait for the current operation to complete.', true);
                    return;
                }
                
                this.addToLog(`> ${trimmedInput}`, false);
                const [cmd, ...args] = trimmedInput.split(' ');
                
                const handlerKey = this.findCommandHandler(cmd, args);
                
                if (this.state.awaitingConfirmation) {
                    this.addToLog('Confirmation protocol aborted. Operation cancelled.', true);
                    this.state.awaitingConfirmation = null;
                    return; 
                }

                if (this.commands.has(handlerKey)) {
                    await this.commands.get(handlerKey).handler(args);
                } else {
                    this.addToLog(`ERROR: Protocol "${trimmedInput}" not recognized.`, true);
                }
            }
            
            findCommandHandler(cmd, args) {
                const multiWordCmd = `${cmd} ${args[0]}`;
                if (this.commands.has(multiWordCmd) && args.length === 1) {
                    return multiWordCmd;
                }
                const setCmd = `set ${args[0]}`;
                if (cmd === 'set' && this.commands.has(setCmd)) {
                    return setCmd;
                }
                return cmd;
            }

            toggleSubsystem(subsystem, name) {
                let status = this.state[subsystem];
                if (typeof status === 'number') {
                    this.state[subsystem] = status > 0 ? 0 : 100;
                } else {
                    this.state[subsystem] = status === 'Online' ? 'Offline' : 'Online';
                }
                this.addToLog(`${name} status: ${this.state[subsystem] === 0 ? 'Offline' : this.state[subsystem]}.`);
                this.updateDisplay();
            }

            toggleMode() {
                this.state.mode = this.state.mode === 'TOWER' ? 'ARMOR' : 'TOWER';
                this.addToLog(`Operational mode switched to ${this.state.mode}.`);
                this.updateDisplay();
            }
            
            toggleAirlock() {
                this.state.airlock = this.state.airlock === 'Sealed' ? 'Open' : 'Sealed';
                this.addToLog(`Airlock status: ${this.state.airlock}.`);
                this.updateDisplay();
            }

            // Updated async command to support aborting
            async runAsyncCommand(startMessage, endMessage, failMessage, duration, callback = null) {
                if (this.state.isBusy) {
                    this.addToLog('System busy. Please wait for the current operation to complete.', true);
                    return;
                }
                
                this.state.isBusy = true;
                const logEntry = this.addToLog(`${startMessage} <div class="spinner"></div>`);
                
                this.state.abortTimeout = setTimeout(() => {
                    this.updateLogEntry(logEntry, endMessage);
                    if (callback) callback();
                    this.state.isBusy = false;
                    this.state.abortTimeout = null;
                }, duration);
            }

            abortProtocol() {
                if (this.state.isBusy && this.state.abortTimeout) {
                    clearTimeout(this.state.abortTimeout);
                    this.state.isBusy = false;
                    this.state.abortTimeout = null;
                    this.addToLog('Protocol aborted. System is now ready for new commands.', true);
                } else {
                    this.addToLog('No active protocol to abort.', true);
                }
            }


            runDiagnostics() {
                setTimeout(() => {
                    this.addToLog(`- Photonic Emitters: ${this.state.lights > 0 ? 'Online' : 'Offline'}`);
                    this.addToLog(`- Ventilation: ${this.state.ventilation > 0 ? 'Active' : 'Offline'}`);
                    this.addToLog(`- Primary Airlock: ${this.state.airlock}`);
                    this.addToLog(`- Energy Shielding: ${this.state.shielding}`);
                    this.addToLog(`- Maneuvering Thrusters: ${this.state.thrusters}`);
                    this.addToLog(`- AI Core: ${this.state.aiStatus}`);
                    this.addToLog(`- Energy Nexus: ${this.state.energyOutput}%`);
                    this.addToLog(`- Fusion Reactor: ${this.state.reactorOutput}%`);
                    this.addToLog(`- Suit Integrity: ${this.state.suitIntegrity}%`);
                }, 500);
            }
            
            rebootSystem() {
                this.state = {
                    mode: "TOWER",
                    lights: 100,
                    ventilation: 0,
                    airlock: "Sealed",
                    shielding: "Offline",
                    thrusters: "Offline",
                    energyOutput: 93,
                    reactorOutput: 97,
                    suitIntegrity: 100,
                    health: 'optimal',
                    aiStatus: 'Nominal',
                    awaitingConfirmation: null,
                    isBusy: false,
                    abortTimeout: null,
                };
                this.updateDisplay();
            }
            
            requestConfirmation(command) {
                this.addToLog(`Confirmation required for "${command}". Enter "confirm shutdown" to proceed.`, false);
                this.state.awaitingConfirmation = command;
            }

            executeConfirmedShutdown() {
                if (this.state.awaitingConfirmation === 'emergency shutdown') {
                    this.state.lights = 0;
                    this.state.ventilation = 0;
                    this.state.airlock = 'Sealed';
                    this.state.shielding = 'Offline';
                    this.state.thrusters = 'Offline';
                    this.state.energyOutput = 0;
                    this.state.reactorOutput = 0;
                    this.state.suitIntegrity = 0;
                    this.state.health = 'critical';
                    this.state.awaitingConfirmation = null;
                    this.state.isBusy = false; 
                    this.addToLog('Emergency shutdown protocol complete. All non-essential systems are offline.', true);
                    this.updateDisplay();
                } else {
                    this.addToLog('ERROR: Shutdown confirmation not required or invalid.', true);
                }
            }

            setNumericValue(subsystem, valueStr, min, max, name) {
                const value = parseInt(valueStr);
                if (isNaN(value) || value < min || value > max) {
                    this.addToLog(`Invalid value for ${name}. Please use a number between ${min} and ${max}.`, true);
                    return;
                }
                this.state[subsystem] = value;
                this.addToLog(`${name} set to ${value}.`);
                this.updateDisplay();
            }

            setAirlockState(state) {
                const newState = state.toLowerCase();
                if (newState === 'open' || newState === 'sealed') {
                    this.state.airlock = newState.charAt(0).toUpperCase() + newState.slice(1);
                    this.addToLog(`Airlock protocol: State changed to ${this.state.airlock}.`);
                    this.updateDisplay();
                } else {
                    this.addToLog('ERROR: Invalid airlock state. Use "open" or "sealed".', true);
                }
            }
            
            initSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.speechRecognition = new SpeechRecognition();
                this.speechRecognition.interimResults = false;
                this.speechRecognition.lang = 'en-US';

                this.speechRecognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript.trim().toLowerCase();
                    this.dom.commandInput.value = transcript;
                    this.executeCommand(transcript);
                    this.stopListening();
                };

                this.speechRecognition.onend = () => {
                    if (this.isListening) {
                        this.speechRecognition.start();
                    } else {
                         this.dom.voiceBtnIcon.textContent = '🎤';
                         this.dom.voiceBtn.classList.remove('listening');
                         this.dom.voiceBtn.setAttribute('aria-pressed', 'false');
                    }
                };

                this.speechRecognition.onerror = (event) => {
                    this.addToLog(`Voice recognition ERROR: ${event.error}`, true);
                    this.stopListening();
                };
            }
            
            toggleVoiceCommand() {
                if (!this.recognitionSupported) return;
                
                if (this.isListening) {
                    this.stopListening();
                } else {
                    this.startListening();
                }
            }

            startListening() {
                try {
                    this.speechRecognition.start();
                    this.isListening = true;
                    this.dom.voiceBtnIcon.textContent = '■';
                    this.dom.voiceBtn.classList.add('listening');
                    this.dom.voiceBtn.setAttribute('aria-pressed', 'true');
                    this.addToLog('Voice command interface active. Listening for input...');
                } catch (e) {
                    this.addToLog('Voice recognition failed to start. Check permissions or try again.', true);
                    this.isListening = false;
                }
            }

            stopListening() {
                this.speechRecognition.stop();
                this.isListening = false;
                this.dom.voiceBtnIcon.textContent = '🎤';
                this.dom.voiceBtn.classList.remove('listening');
                this.dom.voiceBtn.setAttribute('aria-pressed', 'false');
                this.addToLog('Voice command interface deactivated.');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            new QuantumDashboard();
        });
    </script>
</body>
</html>
